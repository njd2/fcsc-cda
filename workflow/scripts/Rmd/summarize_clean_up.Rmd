---
title: "FCS Clean-up summary"
output:
  html_document:
    df_print: paged
---

```{r, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(fig.width=13, fig.height=7, fig_caption=TRUE)

ps <- snakemake@params

MIN_EVENT_SOP1 <- ps[["min_events"]][["sop1"]]
MIN_EVENT_SOP2 <- ps[["min_events"]][["sop2"]]
MIN_EVENT_SOP3 <- ps[["min_events"]][["sop3"]]
VDIFF_LIMIT <- ps[["detector_limits"]][["voltage"]]
GDIFF_LIMIT <- ps[["detector_limits"]][["gain"]]
TRUNCATION <- as.double(ps[["truncation_thresh"]])

df_meta_issues <- read_tsv(
  snakemake@input[["issues"]],
  col_types = cols(
    file_index = "i",
    om = "c",
    group = "c",
    .default = "l"
  )
)

df_voltgain <- read_tsv(
  snakemake@input[["voltgain"]],
  col_types = "icccccccdd"
)

df_ranges <- read_tsv(
  snakemake@input[["ranges"]],
  col_types = "icid",
  col_names = c("file_index", "channel", "nover", "fracover")
) %>%
  left_join(df_meta_issues, by = "file_index")

df_all_issues <- df_meta_issues %>%
  mutate(
    metadata_error = case_when(
      missing_file ~ "1 missing file",
      has_multi_serial | has_multi_cytometer | has_multi_system ~ "2 muliple systems",
      has_insufficient_events ~ "3 too few events",
      has_voltage_variation | has_gain_variation ~ "4 voltage/gain variation",
      TRUE ~ "5 no metadata error"
    ) %>%
      factor() %>%
      fct_relabel(~ str_sub(.x, 3)),
    channel_error = case_when(
      metadata_error != "no metadata error" ~ "1 previous error",
      missing_time ~ "2 missing time channel" ,
      missing_scatter_area ~ "3 missing scatter area",
      missing_scatter_height ~ "4 missing scatter height",
      missing_colors ~ "5 missing color channel",
      TRUE ~ "6 no channel error"
    ) %>%
      factor() %>%
      fct_relabel(~ str_sub(.x, 3)),
    time_error = case_when(
      channel_error != "no channel error" ~ "1 previous error",
      has_time_anomaly ~ "2 has time anomaly",
      has_time_nonlinear ~ "3 has uneven flow rate",
      TRUE ~ "4 no time error"
    ) %>%
      factor() %>%
      fct_relabel(~ str_sub(.x, 3)),
    metadata_alpha = if_else(metadata_error == "no metadata error", 0.5, 1),
    channel_alpha = if_else(channel_error == "no channel error", 0.5, 1),
    time_alpha = if_else(time_error == "no time error", 0.5, 1)
  )
```

This is a summary of the errors found during FCS file cleanup.

The minimum events for each SOP were deemed as follows:

* SOP 1: `r as.integer(MIN_EVENT_SOP1)`
* SOP 2: `r as.integer(MIN_EVENT_SOP2)`
* SOP 3: `r as.integer(MIN_EVENT_SOP3)`

# Voltage/Gain variation

All voltages for each channel for each machine should be the same compared to
SOP-1.

```{r, echo = FALSE, results = "asis"}
df_voltgain %>%
  ggplot(aes(vdiff, om, color = std_name_long)) +
  geom_jitter(width = 0.005, height = 0.1, size = 0.5, na.rm= TRUE) +
  facet_wrap(c("group"), nrow = 1) +
  labs(x = "Relative $PnV difference from SOP-1 ((x - x1) / x1)", y = NULL, color = "Channel")

df_voltgain %>%
  ggplot(aes(gdiff, om, color = std_name_long)) +
  geom_jitter(width = 0, height = 0.1, size = 0.5, na.rm= TRUE) +
  facet_wrap(c("group"), nrow = 1) +
  labs(x = "Relative $PnG difference from SOP-1 ((x - x1) / x1)", y = NULL, color = "Channel")
```

# Metadata Errors

Error explanation:

1. missing file: FCS file is completely missing from dataset
2. multiple systems: FCS files were acquired on different cytometers as found by
   querying the $CYT (cytometer), $SYS (operating system), and $CYTSN (serial
   number)
3. too few events: FCS file has less than the minimum required events as
   dictated by the SOP (before filtering as done with the time channel below)
4. voltage/gain variation: voltage and/or gain within each channel has
   unacceptable variation
   
For 6, variation was computed as the relative difference of each non-SOP-1 FCS
file to those in SOP-1 (ie (x - x1) / x1). The unacceptable limits for voltage
and gain were `r VDIFF_LIMIT` and `r GDIFF_LIMIT` respectively.

```{r, echo = FALSE, results = "asis"}
df_all_issues %>%
  ggplot(aes(y = om, fill = metadata_error, alpha = metadata_alpha)) +
  geom_bar() +
  facet_wrap(c("group"), nrow = 1) +
  scale_alpha_continuous(limits = c(0, 1)) +
  labs(x = "Number of Files", y = NULL, fill = "Metadata Error") +
  theme(legend.position = "bottom") +
  guides(alpha = "none")
```

# Channel Errors

Error explanation:

1. previous error: an error from the above section
2. missing time channel: time channel is absent from the FCS file
3. missing scatter area: missing either FSC-A or SSC-A
4. missing scatter height: missing either FSC-H or SSC-H
5. missing color channels: at least 1 of the 8 standardized color channels is
   missing
   
```{r, echo = FALSE, results = "asis"}
df_all_issues %>%
  ggplot(aes(y = om, fill = channel_error, alpha = channel_alpha)) +
  geom_bar() +
  facet_wrap(c("group"), nrow = 1) +
  scale_alpha_continuous(limits = c(0, 1)) +
  labs(x = "Number of Files", y = NULL, fill = "Channel Error") +
  theme(legend.position = "bottom") +
  guides(alpha = "none")
```

# Time Channel Errors

Error explanation:

1. previous error: has at least one error from the previous two sections
2. has time anomaly: has either a large pause in flow or a non-monotonic time
   channel
3. has uneven flow rate: flow rate was determined to be uneven

Note that for 2 and 3, an attempt was made to gate the regions of the time
channel for which these errors did not occur. Being labeled with an error means
that not enough events per the SOP were determined to be error-free.

```{r, echo = FALSE, results = "asis"}
df_all_issues %>%
  ggplot(aes(y = om, fill = time_error, alpha = time_alpha)) +
  geom_bar() +
  facet_wrap(c("group"), nrow = 1) +
  scale_alpha_continuous(limits = c(0, 1)) +
  labs(x = "Number of Files", y = NULL, fill = "Time Error") +
  theme(legend.position = "bottom") +
  guides(alpha = "none")
```

# Truncation/range summary

Some channels contain events that are at/near their maximum range.

Events were considered truncated if they were greater than `r (TRUNCATION * 100)`
percent of the range given by $PnR for the given channel.

## Scatter

```{r, echo = FALSE, results = "asis"}
df_ranges %>%
  filter(channel %in% c("fsc_a", "fsc_h", "ssc_a", "ssc_h")) %>%
  ggplot(aes(fracover, om, color = channel)) +
  geom_jitter(width = 0, height = 0.1, size = 0.5) +
  facet_wrap(c("group"), nrow = 1) +
  labs(x = "Truncation Rate", y = NULL, fill = "Channel") +
  theme(legend.position = "bottom")
```

## Color

```{r, echo = FALSE, results = "asis"}
df_ranges %>%
  filter(!channel %in% c("fsc_a", "fsc_h", "ssc_a", "ssc_h")) %>%
  ggplot(aes(fracover, om, color = channel)) +
  geom_jitter(width = 0, height = 0.1, size = 0.5) +
  facet_wrap(c("group"), nrow = 1) +
  labs(x = "Truncation Rate", y = NULL, fill = "Channel") +
  theme(legend.position = "bottom")
```
