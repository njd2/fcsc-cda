---
title: "FCS files with time issues"
output:
  html_document:
    df_print: paged
---

```{r, include=FALSE}
library(tidyverse)
library(scattermore)

knitr::opts_chunk$set(fig.width=8, fig.height=4, fig_caption=TRUE)

process_gates <- function(df, gt) {
  df %>%
    group_by(file_index) %>%
    mutate(novalid = sum(valid) == 0) %>%
    mutate(hasgates = n() > 1) %>%
    ungroup() %>%
    add_column(gate_type = gt)
}

df_ano <- read_tsv(
  snakemake@input[["anomaly"]],
  col_types = "iii-l",
  col_names = c("file_index", "start", "end", "valid")
) %>%
  process_gates("anomaly")

df_flat <- read_tsv(
  snakemake@input[["flat"]],
  col_types = "iiil",
  col_names = c("file_index", "start", "end", "valid")
) %>%
  process_gates("flow rate")

# ASSUME these are sorted by file/event index
df_events <- read_tsv(
  snakemake@input[["events"]],
  col_types = "iid",
  col_names = c("file_index", "event_index", "time")
)

df_meta <- read_tsv(
  snakemake@input[["meta"]],
  col_types = cols(
    machine = "c",
    org = "c",
    file_index = "i",
    material = "c",
    sop = "i",
    eid = "i",
    rep = "i",
    .default = "-"
  )
)

make_plot <- function(df_gates, key, both) {
  i <- key$file_index[[1]]
  m <- df_meta %>%
    filter(file_index == i) %>%
    head(n = 1)
  cat(sprintf("### %s - %s\n\n", m$org, m$machine))
  cat(sprintf("File Index = %d\n\n", i))
  cat(sprintf("SOP = %d\n\n", m$sop))
  cat(sprintf("Experiment = %d\n\n", m$eid))
  cat(sprintf("Rep = %d\n\n", m$rep))
  cat(sprintf("Material = %s\n\n", m$material))
  p <- df_events %>%
    filter(file_index == i) %>%
    ggplot(aes(event_index, time)) +
    geom_scattermore(pointsize=2)
  # TODO add colors for each gate type
  if (FALSE) {
    rest <- list(
      geom_rect(
        data = df_gates,
        aes(xmin = start, xmax = end, ymin = 0, ymax = Inf, fill = gate_type),
        alpha = 0.2,
        inherit.aes = FALSE
      ),
      scale_fill_discrete(drop = FALSE),
      labs(x = "Event", y = "Time Channel", fill = "Gate Type")
    )
  } else {
    rest <- list(
      geom_vline(
        data = slice_tail(df_gates, n = -1),
        aes(xintercept = start),
        color = "red",
        linetype = "dashed"
      ),
      labs(x = "Event", y = "Time Channel")
    )
  }
  print(p + rest)
  cat("\n\n")
}

```

The following are the time channels of the FCS files with detected issues 
(further elaborated below).

# Invalid Files

In each of these cases, the minimum nunmber of required events was not
achieved after trying to gate around these issues.

## Files with anomalies

These files have one or both of these issues:

* (large) non-monotonicity: the time channel reset to (near) zero in the middle
  of the run

* gaps: the time channel has a large pause in the middle, which usually
  indicates a clog or bubble

```{r, echo = FALSE, results = "asis"}
df_ano %>%
  filter(novalid) %>%
  group_by(file_index) %>%
  group_walk(~ make_plot(.x, .y, FALSE))
```

## Files with non-linearity

These files have large deviations in flow rate somewhere in the middle.

```{r, echo = FALSE, results = "asis"}
df_flat %>%
  filter(novalid) %>%
  group_by(file_index) %>%
  group_walk(~ make_plot(.x, .y, FALSE))
```

# Valid Files

These are files that have at least one gate but exceeded the minimum event
count in at least one gate.

```{r, echo = FALSE, results = "asis"}
bind_rows(
  df_flat,
  df_ano
) %>%
  mutate(gate_type = factor(gate_type)) %>%
  filter(!novalid) %>%
  filter(hasgates) %>%
  arrange(file_index) %>%
  group_by(file_index) %>%
  group_walk(~ make_plot(.x, .y, TRUE))
```
